#!/usr/bin/python2
"""
A user software manager. Takes compiled applications 
and sticks them under ~/Apps, each program to its
own directory.
"""

from __future__ import print_function
import glob
import os
import shutil

# Directory which this program manages.
ROOT = os.path.join(os.path.expanduser("~"), "Apps")

# The directory to check for new stuff in
INSTALL = os.path.join(ROOT, "install")

# The script that is added to the user's shell init file
SCRIPT = """##### LINES ADDED BY USM #####
for f in ~/Apps/*; do
    PATH=$f/bin:$PATH
    PKG_CONFIG_PATH=$f/lib/pkgconfig:$PKG_CONFIG_PATH
    MANPATH="$f/man:$f/share/man:$MANPATH"
done
export PATH
export PKG_CONFIG_PATH
export MANPATH
"""

def usm_init():
    "Create the initial USM directory for this user"
    print("Creating ~/Apps...")
    os.mkdir(ROOT)
    print("Creating ~/Apps/install...")
    os.mkdir(INSTALL)
    rcfile = raw_input("Enter the file to add the PATH loader script to (e.g. ~/.bashrc) [EMPTY=Do Not Add]: ")
    if rcfile != "":
        with open(os.path.expanduser(rcfile), "a") as scriptfile:
            scriptfile.write(SCRIPT)

def usm_add(software, version):
    "Add the directory to the listing"
    print("Installing {0} version {1}".format(software, version))
    os.rename(INSTALL, os.path.join(ROOT, "{0}--{1}".format(software, version)))
    os.mkdir(INSTALL)

def usm_ls(pattern="*"):
    "Print out all matching packages"
    for x in glob.glob(os.path.join(ROOT, pattern)):
        print(os.path.basename(x))

def usm_del(pattern="*"):
    "Delete some software from the system"
    for dirname in glob.glob(os.path.join(ROOT, pattern)):
        if raw_input("Remove {0} [Y/...]? ".format(dirname)) == "Y":
            print("Deleting " + dirname)
            shutil.rmtree(os.path.join(ROOT, dirname))

def usm_help():
    print(""" USM - The User Software Manager
-------------------------------
usm help: Show this help page.

usm init: Create and setup the USM directory.

usm add <software> <version>: Take the contents of ~/Apps/install, rename
the directory to the appropriate software, and reset ~/Apps/install.

usm ls [pattern]: Shows all installed packages that match pattern (or all if no pattern given).

usm del [pattern]: Deletes the packages matching pattern (or all if no pattern given). Asks for confirmation on all packages.
""")
    sys.exit(1)

import sys

try:
    command = sys.argv[1]
    if command == "help":
        usm_help()
    elif command == "init":
        usm_init()
    elif command == "add":
        usm_add(sys.argv[2], sys.argv[3])
    elif command == "ls":
        if len(sys.argv) == 2:
            usm_ls()
        else:
            usm_ls(sys.argv[2])
    elif command == "del":
        usm_del(sys.argv[2])
    else:
        usm_help()

except IndexError:
    usm_help()
